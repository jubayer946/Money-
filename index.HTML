

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Money Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    :root { 
      --bg: #ffffff; 
      --surface: #f8f9fa; 
      --text: #1a1a1a; 
      --text-light: #6b7280; 
      --border: #e5e7eb; 
      --primary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --radius: 16px;
    }
    
    @media (prefers-color-scheme: dark) {
      :root { 
        --bg: #000000; 
        --surface: #0a0a0a; 
        --text: #ffffff; 
        --text-light: #9ca3af; 
        --border: #1f2937; 
      }
    }
    
    html { 
      height: 100%; 
      overflow: hidden;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg); 
      color: var(--text);
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      box-sizing: border-box;
    }
    
    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    #main-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 80px;
    }
    
    .surface { 
      background: var(--surface); 
      border-radius: var(--radius);
    }
    
    .text-light { 
      color: var(--text-light); 
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary:active {
      transform: scale(0.95);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--text);
      border-radius: 12px;
      padding: 12px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-ghost:active {
      background: var(--border);
    }
    
    .input-field {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      color: var(--text);
      width: 100%;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), #8b5cf6);
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      border-top: 1px solid var(--border);
      padding: 8px 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-light);
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    .nav-item:active {
      transform: scale(0.95);
    }
    
    .transaction-item {
      background: var(--surface);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    
    .transaction-item:active {
      transform: scale(0.98);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    
    .modal-content {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .category-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 16px 0;
    }
    
    .category-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 8px;
      border-radius: 12px;
      background: var(--surface);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .category-item:active {
      transform: scale(0.95);
    }
    
    .category-item.selected {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
    }
    
    .fab {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: all 0.2s;
      z-index: 40;
    }
    
    .fab:active {
      transform: scale(0.9);
    }
    
    .hidden {
      display: none !important;
    }
    
    .chart-container {
      position: relative;
      height: 200px;
      margin: 20px 0;
    }
    
    .sync-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--surface);
      border-radius: 12px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      z-index: 90;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .sync-indicator.syncing {
      background: var(--warning);
      color: white;
    }
    
    .sync-indicator.synced {
      background: var(--success);
      color: white;
    }
    
    .sync-indicator.offline {
      background: var(--danger);
      color: white;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .spin {
      animation: spin 1s linear infinite;
    }
    
    /* Add loading spinner for auth */
    .auth-loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Sync Indicator -->
    <div id="sync-indicator" class="sync-indicator hidden">
      <i class="fas fa-sync-alt"></i>
      <span>Syncing...</span>
    </div>
    
    <div id="main-content">
      <!-- Dashboard View -->
      <div id="dashboard-view" class="p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h1 class="text-2xl font-bold">Money Manager</h1>
            <p class="text-light">Track your finances</p>
          </div>
          <button class="btn-ghost" id="settings-btn">
            <i class="fas fa-cog"></i>
          </button>
        </div>
        
        <!-- Balance Card -->
        <div class="stat-card mb-6">
          <div class="text-center">
            <p class="text-light text-sm mb-2">Total Balance</p>
            <h2 id="total-balance" class="text-3xl font-bold">$0.00</h2>
          </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="stat-card">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-light text-sm">Income</p>
                <p id="total-income" class="text-lg font-semibold text-green-500">$0.00</p>
              </div>
              <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-arrow-up text-green-500"></i>
              </div>
            </div>
          </div>
          <div class="stat-card">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-light text-sm">Expenses</p>
                <p id="total-expenses" class="text-lg font-semibold text-red-500">$0.00</p>
              </div>
              <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-arrow-down text-red-500"></i>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Chart -->
        <div class="surface p-4 mb-6">
          <h3 class="font-semibold mb-4">Spending Overview</h3>
          <div class="chart-container">
            <canvas id="spending-chart"></canvas>
          </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="surface p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Recent Transactions</h3>
            <button class="text-primary text-sm font-medium">View All</button>
          </div>
          <div id="recent-transactions">
            <div class="text-center text-light py-8">
              <i class="fas fa-receipt text-4xl mb-4 opacity-50"></i>
              <p>No transactions yet</p>
              <p class="text-sm">Add your first transaction to get started</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Transactions View -->
      <div id="transactions-view" class="p-6 hidden">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold">Transactions</h1>
          <div class="flex gap-2">
            <button class="btn-ghost">
              <i class="fas fa-filter"></i>
            </button>
            <button class="btn-ghost">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        
        <div id="transactions-list">
          <div class="text-center text-light py-8">
            <i class="fas fa-receipt text-4xl mb-4 opacity-50"></i>
            <p>No transactions yet</p>
            <p class="text-sm">Add your first transaction to get started</p>
          </div>
        </div>
      </div>
      
      <!-- Analytics View -->
      <div id="analytics-view" class="p-6 hidden">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold">Analytics</h1>
          <button class="btn-ghost">
            <i class="fas fa-calendar"></i>
          </button>
        </div>
        
        <!-- Monthly Summary -->
        <div class="stat-card mb-6">
          <h3 class="font-semibold mb-4">This Month</h3>
          <div class="grid grid-cols-3 gap-4">
            <div class="text-center">
              <p class="text-light text-sm">Income</p>
              <p id="monthly-income" class="text-lg font-semibold text-green-500">$0.00</p>
            </div>
            <div class="text-center">
              <p class="text-light text-sm">Expenses</p>
              <p id="monthly-expenses" class="text-lg font-semibold text-red-500">$0.00</p>
            </div>
            <div class="text-center">
              <p class="text-light text-sm">Savings</p>
              <p id="monthly-savings" class="text-lg font-semibold text-blue-500">$0.00</p>
            </div>
          </div>
        </div>
        
        <!-- Category Breakdown -->
        <div class="surface p-4">
          <h3 class="font-semibold mb-4">Category Breakdown</h3>
          <div class="chart-container">
            <canvas id="category-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Profile View -->
      <div id="profile-view" class="p-6 hidden">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold">Profile</h1>
        </div>
        
        <div class="surface p-6 mb-6">
          <div class="text-center">
            <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-user text-white text-2xl"></i>
            </div>
            <h3 class="font-semibold text-lg" id="user-display-name">Money Manager User</h3>
            <p class="text-light" id="user-email">Not signed in</p>
            <button id="auth-btn" class="btn-primary mt-4">
              <i class="fas fa-sign-in-alt"></i>
              Sign In with Google
            </button>
            <!-- Alternative sign-in for mobile/popup issues -->
            <p class="text-xs text-light mt-2">Having trouble? <a href="#" id="auth-redirect-link" class="text-primary">Try alternative sign-in</a></p>
          </div>
        </div>
        
        <!-- Have to Pay Section -->
        <div class="surface p-4 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Have to Pay</h3>
            <span id="debt-total" class="text-lg font-bold text-red-500">$0.00</span>
          </div>
          <div id="debt-list">
            <div class="text-center text-light py-4">
              <i class="fas fa-hand-holding-usd text-2xl mb-2 opacity-50"></i>
              <p class="text-sm">No debts tracked yet</p>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="surface p-4 flex items-center justify-between" id="manage-categories-btn">
            <div class="flex items-center gap-3">
              <i class="fas fa-tags text-primary"></i>
              <span>Manage Categories</span>
            </div>
            <i class="fas fa-chevron-right text-light"></i>
          </div>
          
          <div class="surface p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fas fa-bell text-primary"></i>
              <span>Notifications</span>
            </div>
            <i class="fas fa-chevron-right text-light"></i>
          </div>
          
          <div class="surface p-4 flex items-center justify-between" id="export-data-btn">
            <div class="flex items-center gap-3">
              <i class="fas fa-download text-primary"></i>
              <span>Export Data</span>
            </div>
            <i class="fas fa-chevron-right text-light"></i>
          </div>
          
          <div class="surface p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fas fa-shield-alt text-primary"></i>
              <span>Privacy</span>
            </div>
            <i class="fas fa-chevron-right text-light"></i>
          </div>
          
          <div class="surface p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fas fa-question-circle text-primary"></i>
              <span>Help & Support</span>
            </div>
            <i class="fas fa-chevron-right text-light"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="flex">
        <div class="nav-item active" data-view="dashboard">
          <i class="fas fa-home text-xl mb-1"></i>
          <span class="text-xs">Home</span>
        </div>
        <div class="nav-item" data-view="transactions">
          <i class="fas fa-list text-xl mb-1"></i>
          <span class="text-xs">Transactions</span>
        </div>
        <div class="nav-item" data-view="analytics">
          <i class="fas fa-chart-bar text-xl mb-1"></i>
          <span class="text-xs">Analytics</span>
        </div>
        <div class="nav-item" data-view="profile">
          <i class="fas fa-user text-xl mb-1"></i>
          <span class="text-xs">Profile</span>
        </div>
      </div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" id="add-transaction-btn">
      <i class="fas fa-plus"></i>
    </button>
    
    <!-- Add Transaction Modal -->
    <div id="add-transaction-modal" class="modal hidden">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Add Transaction</h2>
          <button id="close-modal" class="btn-ghost">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="transaction-form">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Type</label>
            <div class="grid grid-cols-3 gap-2">
              <button type="button" id="income-btn" class="btn-primary">
                <i class="fas fa-arrow-up"></i>
                Income
              </button>
              <button type="button" id="expense-btn" class="btn-ghost">
                <i class="fas fa-arrow-down"></i>
                Expense
              </button>
              <button type="button" id="will-btn" class="btn-ghost">
                <i class="fas fa-hand-holding-usd"></i>
                Have to Pay
              </button>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Amount</label>
            <input type="number" id="amount" class="input-field" placeholder="0.00" step="0.01" required>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Description (Optional)</label>
            <input type="text" id="description" class="input-field" placeholder="Enter description (optional)">
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Category</label>
            <div class="category-grid" id="category-grid">
              <!-- Categories will be populated by JavaScript -->
            </div>
          </div>
          
          <div class="mb-6">
            <label class="block text-sm font-medium mb-2">Date</label>
            <input type="date" id="date" class="input-field" required>
          </div>
          
          <button type="submit" class="btn-primary w-full">
            <i class="fas fa-plus"></i>
            Add Transaction
          </button>
        </form>
      </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div id="manage-categories-modal" class="modal hidden">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold">Manage Categories</h2>
          <button id="close-categories-modal" class="btn-ghost">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="mb-6">
          <div class="flex gap-2 mb-4">
            <button id="income-categories-tab" class="btn-primary flex-1">Income</button>
            <button id="expense-categories-tab" class="btn-ghost flex-1">Expense</button>
            <button id="will-categories-tab" class="btn-ghost flex-1">Have to Pay</button>
          </div>
          
          <div id="categories-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
            <!-- Categories will be populated here -->
          </div>
          
          <div class="border-t pt-4">
            <h4 class="font-medium mb-3">Add New Category</h4>
            <div class="flex gap-2 mb-2">
              <input type="text" id="new-category-name" class="input-field flex-1" placeholder="Category name">
              <select id="new-category-icon" class="input-field w-20">
                <option value="fas fa-circle">‚óè</option>
                <option value="fas fa-star">‚òÖ</option>
                <option value="fas fa-heart">‚ô•</option>
                <option value="fas fa-home">üè†</option>
                <option value="fas fa-car">üöó</option>
                <option value="fas fa-utensils">üçΩ</option>
                <option value="fas fa-shopping-bag">üõç</option>
                <option value="fas fa-gamepad">üéÆ</option>
                <option value="fas fa-book">üìö</option>
                <option value="fas fa-plane">‚úà</option>
              </select>
            </div>
            <button id="add-category-btn" class="btn-primary w-full">
              <i class="fas fa-plus"></i>
              Add Category
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Module Script -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      push, 
      onValue, 
      remove,
      child,
      update
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCWeH-KD2NqPd_B0w4MjJeofSiXCUEPNs",
      authDomain: "money-34ef6.firebaseapp.com",
      databaseURL: "https://money-34ef6-default-rtdb.firebaseio.com",
      projectId: "money-34ef6",
      storageBucket: "money-34ef6.firebasestorage.app",
      messagingSenderId: "662368167193",
      appId: "1:662368167193:web:8ba5cdaa7d1bf5e0be9188",
      measurementId: "G-PL01L951F5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    
    // Configure provider
    provider.setCustomParameters({
      prompt: 'select_account'
    });

    // Make Firebase services available globally
    window.firebaseServices = {
      database,
      auth,
      provider,
      dbRef: ref,
      dbSet: set,
      dbGet: get,
      dbPush: push,
      dbOnValue: onValue,
      dbRemove: remove,
      dbChild: child,
      dbUpdate: update,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    };

    // Initialize the app after Firebase is loaded
    window.firebaseReady = true;
    if (window.initializeMoneyManager) {
      window.initializeMoneyManager();
    }
  </script>

  <!-- Main App Script -->
  <script>
    // App State
    let transactions = [];
    let currentView = 'dashboard';
    let transactionType = 'income';
    let selectedCategory = '';
    let currentUser = null;
    let userId = null;
    let dbListeners = [];
    let isSigningIn = false;
    
    // Default Categories
    const defaultCategories = {
      income: [
        { id: 'salary', name: 'Salary', icon: 'fas fa-briefcase' },
        { id: 'freelance', name: 'Freelance', icon: 'fas fa-laptop' },
        { id: 'investment', name: 'Investment', icon: 'fas fa-chart-line' },
        { id: 'gift', name: 'Gift', icon: 'fas fa-gift' },
        { id: 'bonus', name: 'Bonus', icon: 'fas fa-star' },
        { id: 'other-income', name: 'Other', icon: 'fas fa-plus-circle' }
      ],
      expense: [
        { id: 'food', name: 'Food', icon: 'fas fa-utensils' },
        { id: 'transport', name: 'Transport', icon: 'fas fa-car' },
        { id: 'shopping', name: 'Shopping', icon: 'fas fa-shopping-bag' },
        { id: 'bills', name: 'Bills', icon: 'fas fa-file-invoice' },
        { id: 'entertainment', name: 'Fun', icon: 'fas fa-gamepad' },
        { id: 'health', name: 'Health', icon: 'fas fa-heart' },
        { id: 'education', name: 'Education', icon: 'fas fa-graduation-cap' },
        { id: 'other-expense', name: 'Other', icon: 'fas fa-minus-circle' }
      ],
      will: [
        { id: 'debt-personal', name: 'Personal Loan', icon: 'fas fa-user-friends' },
        { id: 'debt-credit', name: 'Credit Card', icon: 'fas fa-credit-card' },
        { id: 'debt-bank', name: 'Bank Loan', icon: 'fas fa-university' },
        { id: 'debt-family', name: 'Family/Friends', icon: 'fas fa-home' },
        { id: 'debt-business', name: 'Business Debt', icon: 'fas fa-briefcase' },
        { id: 'debt-other', name: 'Other Debt', icon: 'fas fa-hand-holding-usd' }
      ]
    };
    
    let categories = defaultCategories;
    
    // Initialize app when Firebase is ready
    window.initializeMoneyManager = function() {
      if (window.firebaseServices) {
        console.log('Firebase services initialized');
        initializeApp();
        setupEventListeners();
        setupAuthListener();
        checkRedirectResult();
      }
    };
    
    // Check if Firebase is already loaded
    document.addEventListener('DOMContentLoaded', function() {
      if (window.firebaseReady) {
        window.initializeMoneyManager();
      }
    });
    
    function initializeApp() {
      // Set today's date as default
      document.getElementById('date').valueAsDate = new Date();
      
      // Load data from localStorage as fallback
      const localTransactions = JSON.parse(localStorage.getItem('transactions'));
      if (localTransactions) {
        transactions = localTransactions;
        updateDashboard();
        renderTransactions();
      }
      
      const localCategories = JSON.parse(localStorage.getItem('categories'));
      if (localCategories) {
        categories = localCategories;
      }
      
      populateCategories();
      setupCharts();
    }
    
    function checkRedirectResult() {
      if (!window.firebaseServices) return;
      
      const { auth, getRedirectResult } = window.firebaseServices;
      
      getRedirectResult(auth)
        .then((result) => {
          if (result && result.user) {
            console.log('Redirect sign-in successful:', result.user);
            showToast(`Welcome back, ${result.user.displayName || 'User'}!`);
          }
        })
        .catch((error) => {
          if (error.code && error.code !== 'auth/popup-blocked') {
            console.error('Redirect result error:', error);
          }
        });
    }
    
    function setupAuthListener() {
      if (!window.firebaseServices) return;
      
      const { onAuthStateChanged, auth } = window.firebaseServices;
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          userId = user.uid;
          console.log('User signed in:', user.email);
          updateUserProfile(user);
          setupDatabaseListeners();
          showSyncIndicator('syncing');
          loadUserData();
        } else {
          currentUser = null;
          userId = null;
          console.log('User signed out');
          clearDatabaseListeners();
          updateUserProfile(null);
          // Use local storage when not signed in
          transactions = JSON.parse(localStorage.getItem('transactions')) || [];
          categories = JSON.parse(localStorage.getItem('categories')) || defaultCategories;
          updateDashboard();
          renderTransactions();
        }
        isSigningIn = false;
      });
    }
    
    function setupDatabaseListeners() {
      if (!userId || !window.firebaseServices) return;
      
      const { database, dbRef, dbOnValue } = window.firebaseServices;
      
      // Clear existing listeners
      clearDatabaseListeners();
      
      // Listen to transactions
      const transactionsRef = dbRef(database, `users/${userId}/transactions`);
      const transactionListener = dbOnValue(transactionsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          transactions = Object.keys(data).map(key => ({
            ...data[key],
            id: key
          })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } else {
          transactions = [];
        }
        updateDashboard();
        renderTransactions();
        updateAnalytics();
        showSyncIndicator('synced');
      }, (error) => {
        console.error('Database listener error:', error);
        showSyncIndicator('offline');
      });
      dbListeners.push(transactionListener);
      
      // Listen to categories
      const categoriesRef = dbRef(database, `users/${userId}/categories`);
      const categoryListener = dbOnValue(categoriesRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          categories = data;
        } else {
          categories = defaultCategories;
          // Save default categories to Firebase
          saveCategoriesToFirebase();
        }
        populateCategories();
      });
      dbListeners.push(categoryListener);
    }
    
    function clearDatabaseListeners() {
      dbListeners.forEach(listener => {
        if (typeof listener === 'function') {
          listener();
        }
      });
      dbListeners = [];
    }
    
    function updateUserProfile(user) {
      const displayNameElement = document.getElementById('user-display-name');
      const emailElement = document.getElementById('user-email');
      const authBtn = document.getElementById('auth-btn');
      
      if (user) {
        displayNameElement.textContent = user.displayName || 'Money Manager User';
        emailElement.textContent = user.email || 'Signed in';
        authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Sign Out';
        authBtn.onclick = handleSignOut;
      } else {
        displayNameElement.textContent = 'Money Manager User';
        emailElement.textContent = 'Not signed in';
        authBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In with Google';
        authBtn.onclick = handleSignIn;
      }
    }
    
    function handleSignIn() {
      if (!window.firebaseServices) {
        console.error('Firebase services not initialized');
        showToast('Authentication service not ready. Please refresh and try again.');
        return;
      }
      
      if (isSigningIn) {
        console.log('Sign-in already in progress');
        return;
      }
      
      isSigningIn = true;
      const authBtn = document.getElementById('auth-btn');
      authBtn.innerHTML = '<div class="auth-loading"></div> Signing In...';
      authBtn.disabled = true;
      
      const { auth, provider, signInWithPopup } = window.firebaseServices;
      
      console.log('Attempting sign-in with popup...');
      
      signInWithPopup(auth, provider)
        .then((result) => {
          const user = result.user;
          console.log('Sign in successful:', user.email);
          showToast(`Welcome, ${user.displayName || 'User'}!`);
        })
        .catch((error) => {
          console.error('Sign in error:', error.code, error.message);
          
          // Re-enable button
          authBtn.disabled = false;
          authBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In with Google';
          isSigningIn = false;
          
          // Provide specific error messages
          let errorMessage = 'Failed to sign in. ';
          
          switch(error.code) {
            case 'auth/popup-blocked':
              errorMessage = 'Popup was blocked. Please allow popups or use the alternative sign-in method below.';
              break;
            case 'auth/cancelled-popup-request':
              errorMessage = 'Sign in was cancelled.';
              break;
            case 'auth/popup-closed-by-user':
              errorMessage = 'Sign in window was closed.';
              break;
            case 'auth/unauthorized-domain':
              errorMessage = 'This domain is not authorized. Make sure you\'re accessing from the correct URL.';
              break;
            case 'auth/operation-not-allowed':
              errorMessage = 'Google sign-in is not enabled. Please check Firebase configuration.';
              break;
            case 'auth/network-request-failed':
              errorMessage = 'Network error. Please check your internet connection.';
              break;
            default:
              errorMessage += error.message || 'Please try again.';
          }
          
          showToast(errorMessage);
        });
    }
    
    function handleSignInWithRedirect() {
      if (!window.firebaseServices) {
        console.error('Firebase services not initialized');
        showToast('Authentication service not ready. Please refresh and try again.');
        return;
      }
      
      const { auth, provider, signInWithRedirect } = window.firebaseServices;
      
      console.log('Attempting sign-in with redirect...');
      showToast('Redirecting to sign-in page...');
      
      signInWithRedirect(auth, provider)
        .catch((error) => {
          console.error('Redirect sign in error:', error);
          showToast('Failed to redirect for sign in. Please try again.');
        });
    }
    
    function handleSignOut() {
      if (!window.firebaseServices) return;
      
      const { auth, signOut } = window.firebaseServices;
      
      const authBtn = document.getElementById('auth-btn');
      authBtn.innerHTML = '<div class="auth-loading"></div> Signing Out...';
      authBtn.disabled = true;
      
      signOut(auth)
        .then(() => {
          console.log('Sign out successful');
          showToast('Successfully signed out!');
          // Save current data to localStorage before signing out
          localStorage.setItem('transactions', JSON.stringify(transactions));
          localStorage.setItem('categories', JSON.stringify(categories));
        })
        .catch((error) => {
          console.error('Sign out error:', error);
          showToast('Failed to sign out. Please try again.');
          // Re-enable button
          authBtn.disabled = false;
          authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Sign Out';
        });
    }
    
    function loadUserData() {
      if (!userId || !window.firebaseServices) return;
      
      const { database, dbRef, dbGet } = window.firebaseServices;
      
      console.log('Loading user data for:', userId);
      
      // Load transactions
      const transactionsRef = dbRef(database, `users/${userId}/transactions`);
      dbGet(transactionsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          transactions = Object.keys(data).map(key => ({
            ...data[key],
            id: key
          })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          console.log('Loaded', transactions.length, 'transactions');
          updateDashboard();
          renderTransactions();
        } else {
          console.log('No transactions found for user');
        }
      }).catch((error) => {
        console.error('Error loading transactions:', error);
      });
      
      // Load categories
      const categoriesRef = dbRef(database, `users/${userId}/categories`);
      dbGet(categoriesRef).then((snapshot) => {
        if (snapshot.exists()) {
          categories = snapshot.val();
          console.log('Loaded custom categories');
        } else {
          console.log('No custom categories found, using defaults');
          // If no categories exist, save defaults
          saveCategoriesToFirebase();
        }
        populateCategories();
      }).catch((error) => {
        console.error('Error loading categories:', error);
      });
    }
    
    function saveTransactionToFirebase(transaction) {
      if (!userId || !window.firebaseServices) return Promise.resolve();
      
      const { database, dbRef, dbPush, dbSet } = window.firebaseServices;
      
      showSyncIndicator('syncing');
      
      const transactionsRef = dbRef(database, `users/${userId}/transactions`);
      const newTransactionRef = dbPush(transactionsRef);
      
      return dbSet(newTransactionRef, transaction)
        .then(() => {
          console.log('Transaction saved to Firebase');
          showSyncIndicator('synced');
        })
        .catch((error) => {
          console.error('Error saving transaction:', error);
          showSyncIndicator('offline');
          // Save to localStorage as fallback
          localStorage.setItem('transactions', JSON.stringify(transactions));
        });
    }
    
    function saveCategoriesToFirebase() {
      if (!userId || !window.firebaseServices) return Promise.resolve();
      
      const { database, dbRef, dbSet } = window.firebaseServices;
      
      const categoriesRef = dbRef(database, `users/${userId}/categories`);
      
      return dbSet(categoriesRef, categories)
        .then(() => {
          console.log('Categories saved to Firebase');
        })
        .catch((error) => {
          console.error('Error saving categories:', error);
          // Save to localStorage as fallback
          localStorage.setItem('categories', JSON.stringify(categories));
        });
    }
    
    function showSyncIndicator(status) {
      const indicator = document.getElementById('sync-indicator');
      
      if (!userId) {
        indicator.classList.add('hidden');
        return;
      }
      
      indicator.classList.remove('hidden', 'syncing', 'synced', 'offline');
      
      switch(status) {
        case 'syncing':
          indicator.classList.add('syncing');
          indicator.innerHTML = '<i class="fas fa-sync-alt spin"></i><span>Syncing...</span>';
          break;
        case 'synced':
          indicator.classList.add('synced');
          indicator.innerHTML = '<i class="fas fa-check-circle"></i><span>Synced</span>';
          setTimeout(() => {
            indicator.classList.add('hidden');
          }, 2000);
          break;
        case 'offline':
          indicator.classList.add('offline');
          indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Offline</span>';
          break;
      }
    }
    
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const view = item.dataset.view;
          switchView(view);
        });
      });
      
      // Modal controls
      document.getElementById('add-transaction-btn').addEventListener('click', openModal);
      document.getElementById('close-modal').addEventListener('click', closeModal);
      
      // Transaction type buttons
      document.getElementById('income-btn').addEventListener('click', () => setTransactionType('income'));
      document.getElementById('expense-btn').addEventListener('click', () => setTransactionType('expense'));
      document.getElementById('will-btn').addEventListener('click', () => setTransactionType('will'));
      
      // Form submission
      document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
      
      // Close modal on backdrop click
      document.getElementById('add-transaction-modal').addEventListener('click', (e) => {
        if (e.target.id === 'add-transaction-modal') {
          closeModal();
        }
      });
      
      // Category management
      document.getElementById('manage-categories-btn').addEventListener('click', openCategoriesModal);
      document.getElementById('close-categories-modal').addEventListener('click', closeCategoriesModal);
      document.getElementById('export-data-btn').addEventListener('click', exportData);
      
      // Category tabs
      document.getElementById('income-categories-tab').addEventListener('click', () => setCategoryTab('income'));
      document.getElementById('expense-categories-tab').addEventListener('click', () => setCategoryTab('expense'));
      document.getElementById('will-categories-tab').addEventListener('click', () => setCategoryTab('will'));
      
      // Add category
      document.getElementById('add-category-btn').addEventListener('click', addNewCategory);
      
      // Close categories modal on backdrop click
      document.getElementById('manage-categories-modal').addEventListener('click', (e) => {
        if (e.target.id === 'manage-categories-modal') {
          closeCategoriesModal();
        }
      });
      
      // Alternative sign-in link
      document.getElementById('auth-redirect-link').addEventListener('click', (e) => {
        e.preventDefault();
        handleSignInWithRedirect();
      });
    }
    
    function switchView(view) {
      // Hide all views
      document.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add('hidden'));
      
      // Show selected view
      document.getElementById(`${view}-view`).classList.remove('hidden');
      
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-view="${view}"]`).classList.add('active');
      
      currentView = view;
      
      // Update view-specific content
      if (view === 'analytics') {
        updateAnalytics();
      }
    }
    
    function openModal() {
      document.getElementById('add-transaction-modal').classList.remove('hidden');
      document.getElementById('amount').focus();
    }
    
    function closeModal() {
      document.getElementById('add-transaction-modal').classList.add('hidden');
      resetForm();
    }
    
    function resetForm() {
      document.getElementById('transaction-form').reset();
      document.getElementById('date').valueAsDate = new Date();
      setTransactionType('income');
      selectedCategory = '';
      updateCategorySelection();
    }
    
    function setTransactionType(type) {
      transactionType = type;
      
      // Update buttons
      const incomeBtn = document.getElementById('income-btn');
      const expenseBtn = document.getElementById('expense-btn');
      const willBtn = document.getElementById('will-btn');
      
      // Reset all buttons
      incomeBtn.className = 'btn-ghost';
      expenseBtn.className = 'btn-ghost';
      willBtn.className = 'btn-ghost';
      
      // Set active button
      if (type === 'income') {
        incomeBtn.className = 'btn-primary';
      } else if (type === 'expense') {
        expenseBtn.className = 'btn-primary';
      } else if (type === 'will') {
        willBtn.className = 'btn-primary';
      }
      
      // Reset category selection
      selectedCategory = '';
      populateCategories();
    }
    
    function populateCategories() {
      const grid = document.getElementById('category-grid');
      if (!grid) return;
      
      grid.innerHTML = '';
      
      const categoryList = categories[transactionType] || [];
      
      categoryList.forEach(category => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.dataset.category = category.id;
        item.innerHTML = `
          <i class="${category.icon} text-xl mb-2"></i>
          <span class="text-xs text-center">${category.name}</span>
        `;
        
        item.addEventListener('click', () => {
          selectedCategory = category.id;
          updateCategorySelection();
        });
        
        grid.appendChild(item);
      });
    }
    
    function updateCategorySelection() {
      document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      if (selectedCategory) {
        const selectedElement = document.querySelector(`[data-category="${selectedCategory}"]`);
        if (selectedElement) {
          selectedElement.classList.add('selected');
        }
      }
    }
    
    function handleFormSubmit(e) {
      e.preventDefault();
      
      if (!selectedCategory) {
        alert('Please select a category');
        return;
      }
      
      const amount = parseFloat(document.getElementById('amount').value);
      const description = document.getElementById('description').value || 'No description';
      const date = document.getElementById('date').value;
      
      const transaction = {
        type: transactionType,
        amount: amount,
        description: description,
        category: selectedCategory,
        date: date,
        timestamp: new Date().toISOString()
      };
      
      // Save to Firebase if user is signed in
      if (userId) {
        saveTransactionToFirebase(transaction);
      } else {
        // Save to localStorage if not signed in
        transaction.id = Date.now();
        transactions.unshift(transaction);
        saveTransactions();
        updateDashboard();
        renderTransactions();
        updateAnalytics();
      }
      
      closeModal();
      showToast('Transaction added successfully!');
    }
    
    function saveTransactions() {
      localStorage.setItem('transactions', JSON.stringify(transactions));
    }
    
    function saveCategories() {
      if (userId) {
        saveCategoriesToFirebase();
      } else {
        localStorage.setItem('categories', JSON.stringify(categories));
      }
    }
    
    let currentCategoryTab = 'income';
    
    function openCategoriesModal() {
      document.getElementById('manage-categories-modal').classList.remove('hidden');
      setCategoryTab('income');
    }
    
    function closeCategoriesModal() {
      document.getElementById('manage-categories-modal').classList.add('hidden');
    }
    
    function setCategoryTab(tab) {
      currentCategoryTab = tab;
      
      // Update tab buttons
      document.getElementById('income-categories-tab').className = tab === 'income' ? 'btn-primary flex-1' : 'btn-ghost flex-1';
      document.getElementById('expense-categories-tab').className = tab === 'expense' ? 'btn-primary flex-1' : 'btn-ghost flex-1';
      document.getElementById('will-categories-tab').className = tab === 'will' ? 'btn-primary flex-1' : 'btn-ghost flex-1';
      
      renderCategoriesList();
    }
    
    function renderCategoriesList() {
      const container = document.getElementById('categories-list');
      const categoryList = categories[currentCategoryTab] || [];
      
      container.innerHTML = categoryList.map(category => `
        <div class="flex items-center justify-between p-3 surface rounded-lg">
          <div class="flex items-center gap-3">
            <i class="${category.icon}"></i>
            <span>${category.name}</span>
          </div>
          <button class="btn-ghost text-red-500 p-2" onclick="deleteCategory('${category.id}')">
            <i class="fas fa-trash text-sm"></i>
          </button>
        </div>
      `).join('');
    }
    
    window.deleteCategory = function(categoryId) {
      if (confirm('Are you sure you want to delete this category?')) {
        categories[currentCategoryTab] = categories[currentCategoryTab].filter(c => c.id !== categoryId);
        saveCategories();
        renderCategoriesList();
        showToast('Category deleted successfully!');
      }
    }
    
    function addNewCategory() {
      const name = document.getElementById('new-category-name').value.trim();
      const icon = document.getElementById('new-category-icon').value;
      
      if (!name) {
        alert('Please enter a category name');
        return;
      }
      
      const newCategory = {
        id: `${currentCategoryTab}-${Date.now()}`,
        name: name,
        icon: icon
      };
      
      if (!categories[currentCategoryTab]) {
        categories[currentCategoryTab] = [];
      }
      
      categories[currentCategoryTab].push(newCategory);
      saveCategories();
      renderCategoriesList();
      
      // Clear form
      document.getElementById('new-category-name').value = '';
      document.getElementById('new-category-icon').value = 'fas fa-circle';
      
      showToast('Category added successfully!');
    }
    
    function exportData() {
      const data = {
        transactions: transactions,
        categories: categories,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `money-manager-data-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Data exported successfully!');
    }
    
    function updateDashboard() {
      const income = transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
      
      const expenses = transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
      
      const debtItems = transactions.filter(t => t.type === 'will');
      
      const balance = income - expenses;
      
      document.getElementById('total-balance').textContent = formatCurrency(balance);
      document.getElementById('total-income').textContent = formatCurrency(income);
      document.getElementById('total-expenses').textContent = formatCurrency(expenses);
      
      // Update recent transactions (exclude debt items from dashboard)
      const recentContainer = document.getElementById('recent-transactions');
      const recentTransactions = transactions.filter(t => t.type !== 'will').slice(0, 5);
      
      if (recentTransactions.length === 0) {
        recentContainer.innerHTML = `
          <div class="text-center text-light py-8">
            <i class="fas fa-receipt text-4xl mb-4 opacity-50"></i>
            <p>No transactions yet</p>
            <p class="text-sm">Add your first transaction to get started</p>
          </div>
        `;
      } else {
        recentContainer.innerHTML = recentTransactions.map(transaction => {
          const category = [...(categories.income || []), ...(categories.expense || [])]
            .find(c => c.id === transaction.category);
          
          return `
            <div class="transaction-item">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 ${transaction.type === 'income' ? 'bg-green-100' : 'bg-red-100'} rounded-full flex items-center justify-center">
                  <i class="${category?.icon || 'fas fa-circle'} ${transaction.type === 'income' ? 'text-green-500' : 'text-red-500'}"></i>
                </div>
                <div>
                  <p class="font-medium">${transaction.description}</p>
                  <p class="text-light text-sm">${formatDate(transaction.date)}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-semibold ${transaction.type === 'income' ? 'text-green-500' : 'text-red-500'}">
                  ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                </p>
              </div>
            </div>
          `;
        }).join('');
      }
      
      updateSpendingChart();
      updateDebtList();
    }
    
    function updateDebtList() {
      const debtItems = transactions.filter(t => t.type === 'will');
      const debtContainer = document.getElementById('debt-list');
      const debtTotalElement = document.getElementById('debt-total');
      
      // Calculate total debt
      const totalDebt = debtItems.reduce((sum, item) => sum + item.amount, 0);
      debtTotalElement.textContent = formatCurrency(totalDebt);
      
      if (debtItems.length === 0) {
        debtContainer.innerHTML = `
          <div class="text-center text-light py-4">
            <i class="fas fa-hand-holding-usd text-2xl mb-2 opacity-50"></i>
            <p class="text-sm">No debts tracked yet</p>
          </div>
        `;
      } else {
        debtContainer.innerHTML = debtItems.slice(0, 10).map(item => {
          const category = [...(categories.income || []), ...(categories.expense || []), ...(categories.will || [])]
            .find(c => c.id === item.category);
          
          return `
            <div class="flex items-center justify-between p-3 surface rounded-lg mb-2">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                  <i class="${category?.icon || 'fas fa-hand-holding-usd'} text-red-500 text-sm"></i>
                </div>
                <div>
                  <p class="font-medium text-sm">${item.description}</p>
                  <p class="text-light text-xs">${category?.name || 'Other'} ‚Ä¢ ${formatDate(item.date)}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-semibold text-red-500 text-sm">${formatCurrency(item.amount)}</p>
              </div>
            </div>
          `;
        }).join('');
        
        // Add total summary if there are multiple debts
        if (debtItems.length > 1) {
          debtContainer.innerHTML += `
            <div class="border-t pt-3 mt-3">
              <div class="flex items-center justify-between">
                <span class="font-semibold">Total Amount to Pay:</span>
                <span class="font-bold text-red-500 text-lg">${formatCurrency(totalDebt)}</span>
              </div>
            </div>
          `;
        }
      }
    }
    
    function renderTransactions() {
      const container = document.getElementById('transactions-list');
      
      if (transactions.length === 0) {
        container.innerHTML = `
          <div class="text-center text-light py-8">
            <i class="fas fa-receipt text-4xl mb-4 opacity-50"></i>
            <p>No transactions yet</p>
            <p class="text-sm">Add your first transaction to get started</p>
          </div>
        `;
        return;
      }
      
      // Group transactions by date
      const groupedTransactions = transactions.reduce((groups, transaction) => {
        const date = transaction.date;
        if (!groups[date]) {
          groups[date] = [];
        }
        groups[date].push(transaction);
        return groups;
      }, {});
      
      container.innerHTML = Object.entries(groupedTransactions)
        .sort(([a], [b]) => new Date(b) - new Date(a))
        .map(([date, dayTransactions]) => {
          const dayTotal = dayTransactions.reduce((sum, t) => {
            if (t.type === 'will') return sum; // Don't include debt in daily totals
            return sum + (t.type === 'income' ? t.amount : -t.amount);
          }, 0);
          
          return `
            <div class="mb-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-medium">${formatDate(date)}</h3>
                <span class="text-sm ${dayTotal >= 0 ? 'text-green-500' : 'text-red-500'}">
                  ${dayTotal >= 0 ? '+' : ''}${formatCurrency(dayTotal)}
                </span>
              </div>
              <div class="space-y-2">
                ${dayTransactions.map(transaction => {
                  const category = [...(categories.income || []), ...(categories.expense || []), ...(categories.will || [])]
                    .find(c => c.id === transaction.category);
                  
                  let bgColor, textColor, prefix;
                  if (transaction.type === 'income') {
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-500';
                    prefix = '+';
                  } else if (transaction.type === 'expense') {
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-500';
                    prefix = '-';
                  } else { // debt/will
                    bgColor = 'bg-orange-100';
                    textColor = 'text-orange-500';
                    prefix = 'Owe: ';
                  }
                  
                  return `
                    <div class="transaction-item">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 ${bgColor} rounded-full flex items-center justify-center">
                          <i class="${category?.icon || 'fas fa-circle'} ${textColor}"></i>
                        </div>
                        <div>
                          <p class="font-medium">${transaction.description}</p>
                          <p class="text-light text-sm">${category?.name || 'Other'}</p>
                        </div>
                      </div>
                      <div class="text-right">
                        <p class="font-semibold ${textColor}">
                          ${prefix}${formatCurrency(transaction.amount)}
                        </p>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
    }
    
    function updateAnalytics() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      const monthlyTransactions = transactions.filter(t => {
        const transactionDate = new Date(t.date);
        return transactionDate.getMonth() === currentMonth && 
               transactionDate.getFullYear() === currentYear &&
               t.type !== 'will'; // Exclude debt items from analytics
      });
      
      const monthlyIncome = monthlyTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
      
      const monthlyExpenses = monthlyTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
      
      const monthlySavings = monthlyIncome - monthlyExpenses;
      
      document.getElementById('monthly-income').textContent = formatCurrency(monthlyIncome);
      document.getElementById('monthly-expenses').textContent = formatCurrency(monthlyExpenses);
      document.getElementById('monthly-savings').textContent = formatCurrency(monthlySavings);
      
      updateCategoryChart();
    }
    
    function setupCharts() {
      updateSpendingChart();
      updateCategoryChart();
    }
    
    function updateSpendingChart() {
      const ctx = document.getElementById('spending-chart');
      if (!ctx) return;
      
      // Get last 7 days of data
      const last7Days = [];
      const today = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        last7Days.push(date.toISOString().split('T')[0]);
      }
      
      const dailyData = last7Days.map(date => {
        const dayTransactions = transactions.filter(t => t.date === date && t.type !== 'will');
        const income = dayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expenses = dayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        return { date, income, expenses };
      });
      
      if (window.spendingChart) {
        window.spendingChart.destroy();
      }
      
      window.spendingChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: last7Days.map(date => new Date(date).toLocaleDateString('en-US', { weekday: 'short' })),
          datasets: [
            {
              label: 'Income',
              data: dailyData.map(d => d.income),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4
            },
            {
              label: 'Expenses',
              data: dailyData.map(d => d.expenses),
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
    
    function updateCategoryChart() {
      const ctx = document.getElementById('category-chart');
      if (!ctx) return;
      
      const expenseTransactions = transactions.filter(t => t.type === 'expense');
      const categoryTotals = {};
      
      expenseTransactions.forEach(transaction => {
        if (!categoryTotals[transaction.category]) {
          categoryTotals[transaction.category] = 0;
        }
        categoryTotals[transaction.category] += transaction.amount;
      });
      
      const sortedCategories = Object.entries(categoryTotals)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 6);
      
      if (window.categoryChart) {
        window.categoryChart.destroy();
      }
      
      if (sortedCategories.length === 0) {
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        return;
      }
      
      const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'];
      
      window.categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedCategories.map(([categoryId]) => {
            const category = (categories.expense || []).find(c => c.id === categoryId);
            return category?.name || 'Other';
          }),
          datasets: [{
            data: sortedCategories.map(([, amount]) => amount),
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            }
          }
        }
      });
    }
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (date.toDateString() === today.toDateString()) {
        return 'Today';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
      } else {
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
        });<!-- </> -->
      }
    }
    
    function showToast(message) {
      // Simple toast notification
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-lg z-50 text-center';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
  </script>
</body>
</html>